import binascii
import operator
import os
import pickle


def isPE(filename):
    try:
        fh = open(filename, 'rb')
        info = fh.read(2)
        fh.close()
        hexstr = binascii.b2a_hex(info).upper()
        print(hexstr)
        if hexstr == b"4D5A":
            return True
        else:
            return False
    except:
        return False


def createThreeDict(malpath):
    print("Create Three Dict:")
    repo = dict(name='visaya', age=20)
    repo.clear()
    fe = dict(name='visaya', age=20)
    fe.clear()
    row = 0
    for dirpath, dirnames, filenames in os.walk(malpath):
        for filename in filenames:
            filename = os.path.join(dirpath, filename)
            if not isPE(filename):
                print(filename + " is not a pe file")
                continue
            hfile = open(filename)
            content = binascii.b2a_hex(hfile.read()).upper()
            first = ""
            second = ""
            three = ""
            e2 = dict(name='visaya', age=20)
            e2.clear()
            i = 0
            for c in content:
                if i == 0:
                    line = c
                    i = 1
                    continue
                else:
                    line = line + c
                    i = 0
                # print line
                if three == "":
                    three = line
                elif second == "":
                    second = three
                    three = line
                else:
                    first = second
                    second = three
                    three = line
                    tmp = first + second + three
                    # print tmp
                    if ((tmp not in e2) and (tmp in fe)):
                        fe[tmp] += 1
                        e2[tmp] = 1
                    elif (tmp not in e2):
                        fe[tmp] = 1
                        e2[tmp] = 1
            e2.clear()
            hfile.close()

    sorted_fe = sorted(fe.items(), key=operator.itemgetter(1), reverse=True)
    fe.clear()
    i = 0
    for k, v in sorted_fe:
        i = i + 1
        # print k+":"+str(v)
        fe[k] = v
        if i == 5000:
            break
    print(len(fe))
    with open('threedict.dat', 'wb') as f:
        pickle.dump(fe, f)
    print("ok")

# createThreeDict(sys.argv[1])
