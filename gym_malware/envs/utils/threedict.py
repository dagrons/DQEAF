import binascii
import operator
import os
import pickle


def isPE(filename):
    try:
        fh = open(filename, 'rb')
        info = fh.read(2)
        fh.close()
        hexstr = binascii.b2a_hex(info).upper()
        if hexstr == b"4D5A":
            return True
        else:
            return False
    except:
        return False


def createThreeDict(malpath):
    fe = {}
    for dirpath, dirnames, filenames in os.walk(malpath):
        for filename in filenames:
            filename = os.path.join(dirpath, filename)
            print(filename)
            if not isPE(filename):
                print(filename + " is not a pe file")
                continue
            hfile = open(filename, 'rb')
            first = ""
            second = ""
            three = ""
            content = hfile.read(1)
            while len(content) > 0:
                line = binascii.b2a_hex(content).upper()

                if three == "":
                    three = line
                elif second == "":
                    second = three
                    three = line
                else:
                    first = second
                    second = three
                    three = line
                    tmp = first + second + three
                    if tmp in fe:
                        fe[tmp] += 1
                    else:
                        fe[tmp] = 1

                content = hfile.read(1)
            hfile.close()

    sorted_fe = sorted(fe.items(), key=operator.itemgetter(1), reverse=True)
    fe.clear()
    i = 0
    for k, v in sorted_fe:
        print("{}->{}".format(k, v))
        i = i + 1
        fe[k] = v
        if i == 2000:
            break
    print(len(fe))
    with open('threedict1.dat', 'wb') as f:
        pickle.dump(fe, f)


createThreeDict("samples")
